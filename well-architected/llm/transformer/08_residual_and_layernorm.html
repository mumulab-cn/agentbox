<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®‹å·®è¿æ¥ä¸å±‚å½’ä¸€åŒ–è¯¦è§£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2e7d32;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #81c784;
        }
        
        .content-text {
            color: #555;
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .highlight {
            color: #2e7d32;
            font-weight: bold;
            background: #e8f5e9;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* æ®‹å·®è¿æ¥å¯è§†åŒ– */
        .residual-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
            padding: 40px;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 15px;
            position: relative;
        }
        
        .residual-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            position: relative;
        }
        
        .flow-box {
            background: white;
            padding: 25px 40px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            font-weight: bold;
            font-size: 1.2em;
            min-width: 200px;
            text-align: center;
            border: 3px solid #66bb6a;
        }
        
        .flow-box.input {
            background: linear-gradient(135deg, #81c784, #66bb6a);
            color: white;
        }
        
        .flow-box.sublayer {
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
            color: white;
        }
        
        .flow-box.output {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
            color: white;
        }
        
        .arrow-down {
            font-size: 2.5em;
            color: #2e7d32;
            font-weight: bold;
        }
        
        .skip-path {
            position: absolute;
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 400px;
            background: repeating-linear-gradient(
                0deg,
                #ff9800,
                #ff9800 15px,
                transparent 15px,
                transparent 30px
            );
            animation: flow 1.5s linear infinite;
        }
        
        @keyframes flow {
            0% { background-position: 0 0; }
            100% { background-position: 0 30px; }
        }
        
        .skip-label {
            position: absolute;
            left: -150px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            color: #ff9800;
            font-weight: bold;
            font-size: 1.2em;
            white-space: nowrap;
        }
        
        .plus-sign {
            font-size: 3em;
            color: #ff9800;
            font-weight: bold;
        }
        
        /* å±‚å½’ä¸€åŒ–å¯è§†åŒ– */
        .layernorm-demo {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 40px 0;
            padding: 30px;
            background: #f5f5f5;
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .norm-stage {
            text-align: center;
            flex: 1;
            min-width: 250px;
        }
        
        .stage-label {
            color: #2e7d32;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .value-bars {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            justify-content: center;
            height: 150px;
        }
        
        .value-bar {
            width: 35px;
            background: linear-gradient(0deg, #66bb6a, #43a047);
            border-radius: 5px 5px 0 0;
            position: relative;
            animation: barGrow 1s ease-out;
        }
        
        @keyframes barGrow {
            from {
                transform: scaleY(0);
            }
            to {
                transform: scaleY(1);
            }
        }
        
        .value-bars.before .value-bar:nth-child(1) { height: 120px; }
        .value-bars.before .value-bar:nth-child(2) { height: 60px; }
        .value-bars.before .value-bar:nth-child(3) { height: 140px; }
        .value-bars.before .value-bar:nth-child(4) { height: 80px; }
        .value-bars.before .value-bar:nth-child(5) { height: 100px; }
        
        .value-bars.after .value-bar {
            height: 90px;
            background: linear-gradient(0deg, #ffa726, #fb8c00);
        }
        
        .transform-arrow {
            font-size: 3em;
            color: #2e7d32;
        }
        
        /* å…¬å¼æ¡† */
        .formula-box {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-left: 5px solid #2e7d32;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .formula {
            font-size: 1.4em;
            color: #2e7d32;
            text-align: center;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            font-weight: bold;
        }
        
        /* é—®é¢˜ä¸è§£å†³ */
        .problem-solution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }
        
        .problem-box, .solution-box {
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .problem-box {
            background: #ffebee;
            border: 3px solid #ef5350;
        }
        
        .solution-box {
            background: #e8f5e9;
            border: 3px solid #66bb6a;
        }
        
        .box-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .problem-box .box-title {
            color: #c62828;
        }
        
        .solution-box .box-title {
            color: #2e7d32;
        }
        
        .box-content {
            color: #555;
            line-height: 1.8;
        }
        
        /* å¯¹æ¯”è¡¨æ ¼ */
        .comparison-table {
            width: 100%;
            margin: 30px 0;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #66bb6a, #43a047);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: left;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #555;
        }
        
        .comparison-table tr:hover {
            background: #e8f5e9;
        }
        
        /* æç¤ºæ¡† */
        .tip-box {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .tip-title {
            color: #e65100;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .tip-content {
            color: #555;
            line-height: 1.8;
        }
        
        /* ä»£ç å— */
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 25px 0;
            overflow-x: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .problem-solution {
                grid-template-columns: 1fr;
            }
            
            .skip-path {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— æ®‹å·®è¿æ¥ä¸å±‚å½’ä¸€åŒ–</h1>
        <p class="subtitle">Add & Norm - ç¨³å®šæ·±å±‚ç½‘ç»œè®­ç»ƒçš„å…³é”®æŠ€æœ¯</p>
        
        <!-- 1. æ®‹å·®è¿æ¥ -->
        <div class="section">
            <h2 class="section-title">ä¸€ã€æ®‹å·®è¿æ¥ï¼ˆResidual Connectionï¼‰</h2>
            <p class="content-text">
                æ®‹å·®è¿æ¥æ˜¯å°†<span class="highlight">è¾“å…¥ç›´æ¥åŠ åˆ°è¾“å‡º</span>ä¸Šï¼Œ
                è®©æ¢¯åº¦èƒ½å¤Ÿç›´æ¥ä¼ æ’­ï¼Œè§£å†³æ·±å±‚ç½‘ç»œçš„è®­ç»ƒéš¾é¢˜ã€‚
            </p>
            
            <div class="residual-visual">
                <div class="skip-path"></div>
                <div class="skip-label">è·³è·ƒè¿æ¥</div>
                
                <div class="residual-flow">
                    <div class="flow-box input">è¾“å…¥ X</div>
                    
                    <div class="arrow-down">â†“</div>
                    
                    <div class="flow-box sublayer">
                        å­å±‚ï¼ˆæ³¨æ„åŠ›/FFNï¼‰<br>
                        F(X)
                    </div>
                    
                    <div class="arrow-down">â†“</div>
                    
                    <div class="plus-sign">âŠ• ç›¸åŠ </div>
                    
                    <div class="arrow-down">â†“</div>
                    
                    <div class="flow-box output">
                        è¾“å‡º<br>
                        X + F(X)
                    </div>
                </div>
            </div>
            
            <div class="formula-box">
                <div class="formula">Output = LayerNorm(X + Sublayer(X))</div>
                <p style="color: #666; text-align: center; margin-top: 15px;">
                    X: è¾“å…¥ | Sublayer: æ³¨æ„åŠ›å±‚æˆ–FFN | LayerNorm: å±‚å½’ä¸€åŒ–
                </p>
            </div>
        </div>
        
        <!-- 2. ä¸ºä»€ä¹ˆéœ€è¦æ®‹å·® -->
        <div class="section">
            <h2 class="section-title">äºŒã€æ®‹å·®è¿æ¥çš„ä½œç”¨</h2>
            
            <div class="problem-solution">
                <div class="problem-box">
                    <div class="box-title">âŒ æ·±å±‚ç½‘ç»œçš„é—®é¢˜</div>
                    <div class="box-content">
                        <strong>æ¢¯åº¦æ¶ˆå¤±ï¼š</strong><br>
                        â€¢ åå‘ä¼ æ’­æ—¶æ¢¯åº¦é€å±‚è¡°å‡<br>
                        â€¢ æ·±å±‚å‚æ•°éš¾ä»¥æ›´æ–°<br>
                        â€¢ ç½‘ç»œæ€§èƒ½ä¸‹é™<br>
                        <br>
                        <strong>é€€åŒ–é—®é¢˜ï¼š</strong><br>
                        â€¢ å±‚æ•°å¢åŠ ï¼Œæ€§èƒ½åè€Œä¸‹é™<br>
                        â€¢ éš¾ä»¥è®­ç»ƒè¶…è¿‡20å±‚çš„ç½‘ç»œ
                    </div>
                </div>
                
                <div class="solution-box">
                    <div class="box-title">âœ… æ®‹å·®è¿æ¥çš„è§£å†³</div>
                    <div class="box-content">
                        <strong>ç›´æ¥æ¢¯åº¦é€šé“ï¼š</strong><br>
                        â€¢ æ¢¯åº¦å¯ä»¥ç›´æ¥è·³è¿‡å¤šå±‚<br>
                        â€¢ ä¿è¯æ·±å±‚ä¹Ÿèƒ½å¾—åˆ°æ›´æ–°<br>
                        â€¢ è®­ç»ƒæ›´ç¨³å®š<br>
                        <br>
                        <strong>æ’ç­‰æ˜ å°„ï¼š</strong><br>
                        â€¢ æœ€åæƒ…å†µä¸‹å­¦åˆ°F(X)=0<br>
                        â€¢ è‡³å°‘ä¿æŒè¾“å…¥ä¸å˜<br>
                        â€¢ ç½‘ç»œä¸ä¼šé€€åŒ–
                    </div>
                </div>
            </div>
            
            <div class="tip-box">
                <div class="tip-title">ğŸ’¡ å½¢è±¡ç†è§£</div>
                <div class="tip-content">
                    <strong>ç±»æ¯”ï¼š</strong>çˆ¬å±±è·¯çº¿<br>
                    â€¢ <strong>æ— æ®‹å·®ï¼š</strong>å¿…é¡»ä¸€æ­¥æ­¥æ²¿ç€èœ¿èœ’å°è·¯çˆ¬ï¼ˆæ¢¯åº¦é€å±‚ä¼ æ’­ï¼‰<br>
                    â€¢ <strong>æœ‰æ®‹å·®ï¼š</strong>æœ‰ç”µæ¢¯ç›´è¾¾å±±é¡¶ï¼ˆæ¢¯åº¦è·³è·ƒä¼ æ’­ï¼‰<br>
                    <br>
                    å³ä½¿æŸäº›ä¸­é—´å°é˜¶å¾ˆæ»‘ï¼ˆæ¢¯åº¦æ¶ˆå¤±ï¼‰ï¼Œä¹Ÿèƒ½é€šè¿‡ç”µæ¢¯åˆ°è¾¾ç›®çš„åœ°
                </div>
            </div>
        </div>
        
        <!-- 3. å±‚å½’ä¸€åŒ– -->
        <div class="section">
            <h2 class="section-title">ä¸‰ã€å±‚å½’ä¸€åŒ–ï¼ˆLayer Normalizationï¼‰</h2>
            <p class="content-text">
                å±‚å½’ä¸€åŒ–å°†æ¯ä¸ªæ ·æœ¬çš„ç‰¹å¾<span class="highlight">æ ‡å‡†åŒ–ä¸ºå‡å€¼0ã€æ–¹å·®1</span>ï¼Œ
                ç¨³å®šè®­ç»ƒè¿‡ç¨‹ï¼ŒåŠ é€Ÿæ”¶æ•›ã€‚
            </p>
            
            <div class="layernorm-demo">
                <div class="norm-stage">
                    <div class="stage-label">å½’ä¸€åŒ–å‰</div>
                    <div class="value-bars before">
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                    </div>
                    <div style="margin-top: 15px; color: #666;">
                        æ•°å€¼åˆ†æ•£<br>
                        å‡å€¼â‰ 0ï¼Œæ–¹å·®å¤§
                    </div>
                </div>
                
                <div class="transform-arrow">â†’</div>
                
                <div class="norm-stage">
                    <div class="stage-label">å½’ä¸€åŒ–å</div>
                    <div class="value-bars after">
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                        <div class="value-bar"></div>
                    </div>
                    <div style="margin-top: 15px; color: #666;">
                        æ•°å€¼é›†ä¸­<br>
                        å‡å€¼=0ï¼Œæ–¹å·®=1
                    </div>
                </div>
            </div>
            
            <div class="formula-box">
                <div class="formula">LayerNorm(x) = Î³ Â· (x - Î¼) / Ïƒ + Î²</div>
                <p style="color: #666; text-align: center; margin-top: 15px;">
                    Î¼: å‡å€¼ | Ïƒ: æ ‡å‡†å·® | Î³, Î²: å¯å­¦ä¹ å‚æ•°ï¼ˆç¼©æ”¾å’Œå¹³ç§»ï¼‰
                </p>
            </div>
        </div>
        
        <!-- 4. LayerNormè®¡ç®—æ­¥éª¤ -->
        <div class="section">
            <h2 class="section-title">å››ã€å±‚å½’ä¸€åŒ–è®¡ç®—æ­¥éª¤</h2>
            
            <div style="background: #fff3e0; border: 3px solid #ffb74d; border-radius: 15px; padding: 30px; margin: 30px 0;">
                <div style="color: #f57c00; font-size: 1.4em; font-weight: bold; text-align: center; margin-bottom: 25px;">
                    ğŸ§® å®Œæ•´è®¡ç®—ç¤ºä¾‹
                </div>
                
                <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffb74d;">
                    <div style="color: #f57c00; font-weight: bold; margin-bottom: 10px;">è¾“å…¥å‘é‡</div>
                    <div style="color: #555;">x = [2.0, 4.0, 1.0, 5.0]</div>
                </div>
                
                <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffb74d;">
                    <div style="color: #f57c00; font-weight: bold; margin-bottom: 10px;">ç¬¬1æ­¥ï¼šè®¡ç®—å‡å€¼</div>
                    <div style="color: #555;">Î¼ = (2.0 + 4.0 + 1.0 + 5.0) / 4 = <strong>3.0</strong></div>
                </div>
                
                <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffb74d;">
                    <div style="color: #f57c00; font-weight: bold; margin-bottom: 10px;">ç¬¬2æ­¥ï¼šè®¡ç®—æ–¹å·®</div>
                    <div style="color: #555;">
                        ÏƒÂ² = [(2-3)Â² + (4-3)Â² + (1-3)Â² + (5-3)Â²] / 4<br>
                        = [1 + 1 + 4 + 4] / 4 = <strong>2.5</strong><br>
                        Ïƒ = âˆš2.5 â‰ˆ <strong>1.58</strong>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffb74d;">
                    <div style="color: #f57c00; font-weight: bold; margin-bottom: 10px;">ç¬¬3æ­¥ï¼šæ ‡å‡†åŒ–</div>
                    <div style="color: #555;">
                        x_norm = (x - Î¼) / Ïƒ<br>
                        = [(2-3)/1.58, (4-3)/1.58, (1-3)/1.58, (5-3)/1.58]<br>
                        = [<strong>-0.63, 0.63, -1.26, 1.26</strong>]
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #ffb74d;">
                    <div style="color: #f57c00; font-weight: bold; margin-bottom: 10px;">ç¬¬4æ­¥ï¼šç¼©æ”¾å’Œå¹³ç§»ï¼ˆå‡è®¾Î³=1, Î²=0ï¼‰</div>
                    <div style="color: #555;">
                        output = Î³ Â· x_norm + Î² = 1 Â· x_norm + 0<br>
                        = [<strong>-0.63, 0.63, -1.26, 1.26</strong>]
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 5. BatchNorm vs LayerNorm -->
        <div class="section">
            <h2 class="section-title">äº”ã€BatchNorm vs LayerNorm</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>Batch Normalization</th>
                        <th>Layer Normalization</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>å½’ä¸€åŒ–ç»´åº¦</strong></td>
                        <td>åœ¨batchç»´åº¦ä¸Šè®¡ç®—</td>
                        <td>åœ¨ç‰¹å¾ç»´åº¦ä¸Šè®¡ç®—</td>
                    </tr>
                    <tr>
                        <td><strong>ä¾èµ–æ€§</strong></td>
                        <td>ä¾èµ–batchå¤§å°</td>
                        <td>ä¸ä¾èµ–batchï¼Œæ¯ä¸ªæ ·æœ¬ç‹¬ç«‹</td>
                    </tr>
                    <tr>
                        <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                        <td>CNNã€å¤§batchè®­ç»ƒ</td>
                        <td>RNNã€Transformerã€å°batch</td>
                    </tr>
                    <tr>
                        <td><strong>åºåˆ—ä»»åŠ¡</strong></td>
                        <td>ä¸é€‚åˆï¼ˆåºåˆ—é•¿åº¦ä¸åŒï¼‰</td>
                        <td>é€‚åˆï¼ˆæ¯ä¸ªåºåˆ—ç‹¬ç«‹å¤„ç†ï¼‰</td>
                    </tr>
                    <tr>
                        <td><strong>æ¨ç†é˜¶æ®µ</strong></td>
                        <td>éœ€è¦ç»Ÿè®¡é‡çš„ç§»åŠ¨å¹³å‡</td>
                        <td>è®­ç»ƒå’Œæ¨ç†å®Œå…¨ä¸€è‡´</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 6. Add&Normå®Œæ•´æµç¨‹ -->
        <div class="section">
            <h2 class="section-title">å…­ã€Add & Normåœ¨Transformerä¸­çš„ä½ç½®</h2>
            <p class="content-text">
                Transformerçš„æ¯ä¸ªå­å±‚åéƒ½æœ‰<span class="highlight">Add & Norm</span>ï¼š
            </p>
            
            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 30px; border-radius: 15px; margin: 30px 0;">
                <div style="display: flex; flex-direction: column; gap: 20px; max-width: 600px; margin: 0 auto;">
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #66bb6a;">
                        <strong style="color: #2e7d32;">ä½ç½®1ï¼šå¤šå¤´æ³¨æ„åŠ›å</strong><br>
                        <span style="color: #666;">Output = LayerNorm(X + MultiHeadAttention(X))</span>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #66bb6a;">
                        <strong style="color: #2e7d32;">ä½ç½®2ï¼šå‰é¦ˆç½‘ç»œå</strong><br>
                        <span style="color: #666;">Output = LayerNorm(X + FeedForward(X))</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 7. ä»£ç å®ç° -->
        <div class="section">
            <h2 class="section-title">ä¸ƒã€PyTorchä»£ç å®ç°</h2>
            
            <div class="code-block">
<span style="color: #82b1ff;">import</span> torch
<span style="color: #82b1ff;">import</span> torch.nn <span style="color: #82b1ff;">as</span> nn

<span style="color: #82b1ff;">class</span> <span style="color: #ffb74d;">AddAndNorm</span>(nn.Module):
    <span style="color: #90a4ae;">"""æ®‹å·®è¿æ¥ + å±‚å½’ä¸€åŒ–"""</span>
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">__init__</span>(self, d_model=512, dropout=0.1):
        super().__init__()
        self.layer_norm = nn.LayerNorm(d_model)
        self.dropout = nn.Dropout(dropout)
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">forward</span>(self, x, sublayer_output):
        <span style="color: #90a4ae;">"""
        Args:
            x: åŸå§‹è¾“å…¥
            sublayer_output: å­å±‚çš„è¾“å‡º
        """</span>
        <span style="color: #90a4ae;"># æ®‹å·®è¿æ¥ + Dropout</span>
        x = x + self.dropout(sublayer_output)
        <span style="color: #90a4ae;"># å±‚å½’ä¸€åŒ–</span>
        <span style="color: #82b1ff;">return</span> self.layer_norm(x)

<span style="color: #90a4ae;"># æˆ–è€…æ›´ç®€æ´çš„å®ç°</span>
<span style="color: #82b1ff;">class</span> <span style="color: #ffb74d;">SublayerConnection</span>(nn.Module):
    <span style="color: #90a4ae;">"""å­å±‚è¿æ¥ï¼šLayerNorm(x + Sublayer(x))"""</span>
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">__init__</span>(self, d_model, dropout):
        super().__init__()
        self.norm = nn.LayerNorm(d_model)
        self.dropout = nn.Dropout(dropout)
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">forward</span>(self, x, sublayer):
        <span style="color: #90a4ae;"># sublayeræ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚æ³¨æ„åŠ›å±‚æˆ–FFNï¼‰</span>
        <span style="color: #82b1ff;">return</span> self.norm(x + self.dropout(sublayer(x)))

<span style="color: #90a4ae;"># ä½¿ç”¨ç¤ºä¾‹</span>
batch_size = 2
seq_len = 10
d_model = 512

<span style="color: #90a4ae;"># åŸå§‹è¾“å…¥</span>
x = torch.randn(batch_size, seq_len, d_model)

<span style="color: #90a4ae;"># å­å±‚è¾“å‡ºï¼ˆå¦‚æ³¨æ„åŠ›å±‚çš„è¾“å‡ºï¼‰</span>
sublayer_output = torch.randn(batch_size, seq_len, d_model)

<span style="color: #90a4ae;"># Add & Norm</span>
add_norm = AddAndNorm(d_model)
output = add_norm(x, sublayer_output)

<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"è¾“å…¥: {x.shape}"</span>)
<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"è¾“å‡º: {output.shape}"</span>)
<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"å‡å€¼: {output.mean():.4f}"</span>)
<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"æ ‡å‡†å·®: {output.std():.4f}"</span>)
            </div>
        </div>
        
        <!-- æ€»ç»“ -->
        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 30px; border-radius: 15px; margin-top: 40px;">
            <h3 style="color: #2e7d32; text-align: center; margin-bottom: 20px; font-size: 1.5em;">
                âœ¨ æ ¸å¿ƒè¦ç‚¹æ€»ç»“
            </h3>
            <div style="color: #555; line-height: 2; font-size: 1.05em;">
                âœ“ æ®‹å·®è¿æ¥é€šè¿‡è·³è·ƒè¿æ¥è§£å†³æ¢¯åº¦æ¶ˆå¤±ï¼Œè®©æ·±å±‚ç½‘ç»œå¯è®­ç»ƒ<br>
                âœ“ å±‚å½’ä¸€åŒ–ç¨³å®šè®­ç»ƒï¼ŒåŠ é€Ÿæ”¶æ•›ï¼Œæ¯ä¸ªæ ·æœ¬ç‹¬ç«‹å¤„ç†<br>
                âœ“ Add&Normåœ¨æ¯ä¸ªå­å±‚ååº”ç”¨ï¼šOutput = LayerNorm(X + Sublayer(X))<br>
                âœ“ è¿™ä¸¤ä¸ªæŠ€æœ¯æ˜¯Transformerèƒ½å †å åˆ°æ•°åå±‚çš„å…³é”®<br>
                âœ“ ç›¸æ¯”BatchNormï¼ŒLayerNormæ›´é€‚åˆåºåˆ—ä»»åŠ¡å’Œå°batchåœºæ™¯
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; color: #999; font-size: 0.9em;">
            <p>Â© 2025 æ®‹å·®è¿æ¥ä¸å±‚å½’ä¸€åŒ–è¯¦è§£ - Transformerç³»åˆ—æ•™ç¨‹</p>
        </div>
    </div>
</body>
</html>