<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #6a1b9a;
            margin-bottom: 15px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #6a1b9a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ce93d8;
        }
        
        .content-text {
            color: #555;
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .highlight {
            color: #6a1b9a;
            font-weight: bold;
            background: #f3e5f5;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* å¤šå¤´å¹¶è¡Œå¯è§†åŒ– */
        .multi-head-visual {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 15px;
        }
        
        .head-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .head-box:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(106, 27, 154, 0.3);
            border-color: #6a1b9a;
        }
        
        .head-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #6a1b9a;
            margin-bottom: 15px;
        }
        
        .head-visual {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            border: 4px solid #ab47bc;
            border-radius: 50%;
            position: relative;
            animation: rotate 4s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .head-visual::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ab47bc;
            border-radius: 50%;
            top: -2px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .head-desc {
            font-size: 0.9em;
            color: #666;
        }
        
        /* ç»´åº¦åˆ†å‰²å±•ç¤º */
        .dimension-split {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .dim-box {
            text-align: center;
        }
        
        .dim-label {
            color: #6a1b9a;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .dim-visual {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .dim-bar {
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .dim-bar.full {
            width: 512px;
            background: linear-gradient(90deg, #ab47bc, #6a1b9a);
        }
        
        .dim-segments {
            display: flex;
            gap: 5px;
        }
        
        .dim-segment {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .dim-segment:nth-child(1) { background: #e91e63; }
        .dim-segment:nth-child(2) { background: #9c27b0; }
        .dim-segment:nth-child(3) { background: #673ab7; }
        .dim-segment:nth-child(4) { background: #3f51b5; }
        .dim-segment:nth-child(5) { background: #2196f3; }
        .dim-segment:nth-child(6) { background: #00bcd4; }
        .dim-segment:nth-child(7) { background: #009688; }
        .dim-segment:nth-child(8) { background: #4caf50; }
        
        .arrow-down {
            font-size: 2.5em;
            color: #6a1b9a;
        }
        
        /* è®¡ç®—æµç¨‹ */
        .computation-flow {
            background: #fff3e0;
            border: 3px solid #ffb74d;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .flow-title {
            color: #f57c00;
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
        }
        
        .flow-step {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #ffb74d;
        }
        
        .step-num {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #ff9800;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-text {
            display: inline-block;
            vertical-align: top;
            width: calc(100% - 45px);
            color: #555;
            line-height: 1.8;
        }
        
        /* æ‹¼æ¥å¯è§†åŒ– */
        .concat-visual {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
            padding: 25px;
            background: #e8f5e9;
            border-radius: 10px;
        }
        
        .concat-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .concat-piece {
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }
        
        .concat-result {
            padding: 20px 40px;
            border-radius: 10px;
            background: linear-gradient(90deg, #ab47bc, #6a1b9a);
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        /* å…¬å¼æ¡† */
        .formula-box {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-left: 5px solid #6a1b9a;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .formula {
            font-size: 1.3em;
            color: #6a1b9a;
            text-align: center;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            font-weight: bold;
        }
        
        /* å¯¹æ¯”è¡¨æ ¼ */
        .comparison-table {
            width: 100%;
            margin: 30px 0;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #ab47bc, #6a1b9a);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: left;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #555;
        }
        
        .comparison-table tr:hover {
            background: #f3e5f5;
        }
        
        /* æç¤ºæ¡† */
        .tip-box {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .tip-title {
            color: #1565c0;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .tip-content {
            color: #555;
            line-height: 1.8;
        }
        
        /* ä»£ç å— */
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 25px 0;
            overflow-x: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .dim-bar.full {
                width: 100%;
            }
            
            .dim-segments {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”€ å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£</h1>
        <p class="subtitle">Multi-Head Attention - 8ä¸ªæ³¨æ„åŠ›å¤´å¹¶è¡Œæ•æ‰ä¸åŒè¯­ä¹‰å…³ç³»</p>
        
        <!-- 1. åŸºæœ¬æ¦‚å¿µ -->
        <div class="section">
            <h2 class="section-title">ä¸€ã€ä»€ä¹ˆæ˜¯å¤šå¤´æ³¨æ„åŠ›</h2>
            <p class="content-text">
                å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-Head Attentionï¼‰æ˜¯å°†<span class="highlight">å•ä¸ªæ³¨æ„åŠ›åˆ†è§£ä¸ºå¤šä¸ªå¹¶è¡Œçš„æ³¨æ„åŠ›å¤´</span>ï¼Œ
                æ¯ä¸ªå¤´ç‹¬ç«‹å­¦ä¹ ä¸åŒçš„è¯­ä¹‰å…³ç³»ï¼Œæœ€åå°†ç»“æœæ‹¼æ¥èåˆã€‚
            </p>
            
            <div class="tip-box">
                <div class="tip-title">ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¤šå¤´</div>
                <div class="tip-content">
                    <strong>ç±»æ¯”ï¼š</strong>ä»ä¸åŒè§’åº¦è§‚å¯ŸåŒä¸€ä¸ªäº‹ç‰©<br><br>
                    â€¢ <strong>Head 1ï¼š</strong>å…³æ³¨è¯­æ³•å…³ç³»ï¼ˆä¸»è°“å®¾ï¼‰<br>
                    â€¢ <strong>Head 2ï¼š</strong>å…³æ³¨è¯­ä¹‰ç›¸ä¼¼æ€§<br>
                    â€¢ <strong>Head 3ï¼š</strong>å…³æ³¨ä½ç½®è·ç¦»<br>
                    â€¢ <strong>Head 4-8ï¼š</strong>å­¦ä¹ å…¶ä»–éšå«æ¨¡å¼<br>
                    <br>
                    <strong>æ•ˆæœï¼š</strong>å•å¤´åªèƒ½å­¦åˆ°ä¸€ç§æ¨¡å¼ï¼Œå¤šå¤´èƒ½åŒæ—¶æ•æ‰å¤šç§è¯­è¨€ç°è±¡
                </div>
            </div>
        </div>
        
        <!-- 2. 8ä¸ªæ³¨æ„åŠ›å¤´ -->
        <div class="section">
            <h2 class="section-title">äºŒã€8ä¸ªæ³¨æ„åŠ›å¤´å¹¶è¡Œè®¡ç®—</h2>
            <p class="content-text">
                æ ‡å‡†Transformerä½¿ç”¨<span class="highlight">8ä¸ªæ³¨æ„åŠ›å¤´</span>åŒæ—¶å·¥ä½œï¼š
            </p>
            
            <div class="multi-head-visual">
                <div class="head-box">
                    <div class="head-number">Head 1</div>
                    <div class="head-visual"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼1</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 2</div>
                    <div class="head-visual" style="animation-delay: -0.5s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼2</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 3</div>
                    <div class="head-visual" style="animation-delay: -1s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼3</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 4</div>
                    <div class="head-visual" style="animation-delay: -1.5s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼4</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 5</div>
                    <div class="head-visual" style="animation-delay: -2s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼5</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 6</div>
                    <div class="head-visual" style="animation-delay: -2.5s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼6</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 7</div>
                    <div class="head-visual" style="animation-delay: -3s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼7</div>
                </div>
                
                <div class="head-box">
                    <div class="head-number">Head 8</div>
                    <div class="head-visual" style="animation-delay: -3.5s;"></div>
                    <div class="head-desc">å­¦ä¹ æ¨¡å¼8</div>
                </div>
            </div>
        </div>
        
        <!-- 3. ç»´åº¦åˆ†å‰² -->
        <div class="section">
            <h2 class="section-title">ä¸‰ã€ç»´åº¦å¦‚ä½•åˆ†å‰²</h2>
            <p class="content-text">
                å…³é”®æŠ€å·§ï¼šå°†<span class="highlight">512ç»´å‡åˆ†ç»™8ä¸ªå¤´</span>ï¼Œæ¯ä¸ªå¤´å¤„ç†64ç»´
            </p>
            
            <div class="dimension-split">
                <div class="dim-box">
                    <div class="dim-label">åŸå§‹ç»´åº¦</div>
                    <div class="dim-visual">
                        <div class="dim-bar full">d_model = 512</div>
                    </div>
                </div>
                
                <div class="arrow-down">â†“</div>
                
                <div class="dim-box">
                    <div class="dim-label">åˆ†å‰²ä¸º8ä¸ªå¤´</div>
                    <div class="dim-visual">
                        <div class="dim-segments">
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                            <div class="dim-segment">64</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="formula-box">
                <div class="formula">d_k = d_v = d_model / h = 512 / 8 = 64</div>
                <p style="color: #666; text-align: center; margin-top: 15px;">
                    â€¢ h = 8ï¼ˆæ³¨æ„åŠ›å¤´æ•°ï¼‰<br>
                    â€¢ d_k = d_v = 64ï¼ˆæ¯ä¸ªå¤´çš„ç»´åº¦ï¼‰
                </p>
            </div>
        </div>
        
        <!-- 4. è®¡ç®—æµç¨‹ -->
        <div class="section">
            <h2 class="section-title">å››ã€å¤šå¤´æ³¨æ„åŠ›è®¡ç®—æµç¨‹</h2>
            
            <div class="computation-flow">
                <div class="flow-title">ğŸ”„ å®Œæ•´è®¡ç®—æ­¥éª¤</div>
                
                <div class="flow-step">
                    <span class="step-num">1</span>
                    <div class="step-text">
                        <strong>çº¿æ€§æŠ•å½±ï¼š</strong>è¾“å…¥(seq_len, 512)é€šè¿‡W_Qã€W_Kã€W_Vå¾—åˆ°Qã€Kã€V<br>
                        æ¯ä¸ªæƒé‡çŸ©é˜µï¼š(512, 512)
                    </div>
                </div>
                
                <div class="flow-step">
                    <span class="step-num">2</span>
                    <div class="step-text">
                        <strong>åˆ†å‰²ä¸º8ä¸ªå¤´ï¼š</strong>reshapeæ“ä½œ<br>
                        Qã€Kã€V: (seq_len, 512) â†’ (seq_len, 8, 64)
                    </div>
                </div>
                
                <div class="flow-step">
                    <span class="step-num">3</span>
                    <div class="step-text">
                        <strong>å¹¶è¡Œè®¡ç®—æ³¨æ„åŠ›ï¼š</strong>æ¯ä¸ªå¤´ç‹¬ç«‹è®¡ç®—<br>
                        Head_i = Attention(Q_i, K_i, V_i)<br>
                        è¾“å‡ºï¼š8ä¸ª(seq_len, 64)çš„å‘é‡
                    </div>
                </div>
                
                <div class="flow-step">
                    <span class="step-num">4</span>
                    <div class="step-text">
                        <strong>æ‹¼æ¥ï¼š</strong>å°†8ä¸ªå¤´çš„è¾“å‡ºæ‹¼æ¥<br>
                        Concat: (seq_len, 8, 64) â†’ (seq_len, 512)
                    </div>
                </div>
                
                <div class="flow-step">
                    <span class="step-num">5</span>
                    <div class="step-text">
                        <strong>è¾“å‡ºæŠ•å½±ï¼š</strong>é€šè¿‡W_Oçº¿æ€§å˜æ¢<br>
                        æœ€ç»ˆè¾“å‡º: (seq_len, 512)
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 5. æ‹¼æ¥è¿‡ç¨‹ -->
        <div class="section">
            <h2 class="section-title">äº”ã€å¤šå¤´è¾“å‡ºæ‹¼æ¥</h2>
            <p class="content-text">
                8ä¸ªå¤´çš„è¾“å‡ºéœ€è¦<span class="highlight">æ‹¼æ¥ï¼ˆConcatenateï¼‰</span>æˆå®Œæ•´çš„512ç»´å‘é‡ï¼š
            </p>
            
            <div class="concat-visual">
                <div class="concat-row">
                    <div class="concat-piece" style="background: #e91e63;">Head1<br>64ç»´</div>
                    <div class="concat-piece" style="background: #9c27b0;">Head2<br>64ç»´</div>
                    <div class="concat-piece" style="background: #673ab7;">Head3<br>64ç»´</div>
                    <div class="concat-piece" style="background: #3f51b5;">Head4<br>64ç»´</div>
                    <div class="concat-piece" style="background: #2196f3;">Head5<br>64ç»´</div>
                    <div class="concat-piece" style="background: #00bcd4;">Head6<br>64ç»´</div>
                    <div class="concat-piece" style="background: #009688;">Head7<br>64ç»´</div>
                    <div class="concat-piece" style="background: #4caf50;">Head8<br>64ç»´</div>
                </div>
                
                <div style="text-align: center; font-size: 2em; color: #6a1b9a;">â†“ Concat</div>
                
                <div class="concat-row">
                    <div class="concat-result">å®Œæ•´å‘é‡ 512ç»´</div>
                </div>
            </div>
        </div>
        
        <!-- 6. å®Œæ•´å…¬å¼ -->
        <div class="section">
            <h2 class="section-title">å…­ã€å¤šå¤´æ³¨æ„åŠ›å®Œæ•´å…¬å¼</h2>
            
            <div class="formula-box">
                <div class="formula">MultiHead(Q,K,V) = Concat(headâ‚,...,headâ‚ˆ) Â· W_O</div>
                <div class="formula" style="font-size: 1.1em; margin-top: 20px;">head_i = Attention(QÂ·W_Qâ±, KÂ·W_Kâ±, VÂ·W_Vâ±)</div>
                <p style="color: #666; text-align: center; margin-top: 20px;">
                    â€¢ W_Qâ±, W_Kâ±, W_Vâ±: ç¬¬iä¸ªå¤´çš„æŠ•å½±çŸ©é˜µ (512, 64)<br>
                    â€¢ W_O: è¾“å‡ºæŠ•å½±çŸ©é˜µ (512, 512)
                </p>
            </div>
        </div>
        
        <!-- 7. å‚æ•°é‡è®¡ç®— -->
        <div class="section">
            <h2 class="section-title">ä¸ƒã€å‚æ•°é‡åˆ†æ</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æƒé‡çŸ©é˜µ</th>
                        <th>å½¢çŠ¶</th>
                        <th>å‚æ•°é‡</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>W_Q</strong></td>
                        <td>(512, 512)</td>
                        <td>262,144</td>
                        <td>QueryæŠ•å½±</td>
                    </tr>
                    <tr>
                        <td><strong>W_K</strong></td>
                        <td>(512, 512)</td>
                        <td>262,144</td>
                        <td>KeyæŠ•å½±</td>
                    </tr>
                    <tr>
                        <td><strong>W_V</strong></td>
                        <td>(512, 512)</td>
                        <td>262,144</td>
                        <td>ValueæŠ•å½±</td>
                    </tr>
                    <tr>
                        <td><strong>W_O</strong></td>
                        <td>(512, 512)</td>
                        <td>262,144</td>
                        <td>è¾“å‡ºæŠ•å½±</td>
                    </tr>
                    <tr style="background: #f3e5f5;">
                        <td><strong>æ€»è®¡</strong></td>
                        <td>-</td>
                        <td><strong>1,048,576</strong></td>
                        <td>çº¦100ä¸‡å‚æ•°</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 8. ä¼˜åŠ¿å¯¹æ¯” -->
        <div class="section">
            <h2 class="section-title">å…«ã€å¤šå¤´ vs å•å¤´</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>å•å¤´æ³¨æ„åŠ›</th>
                        <th>å¤šå¤´æ³¨æ„åŠ›ï¼ˆ8å¤´ï¼‰</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>è¡¨è¾¾èƒ½åŠ›</strong></td>
                        <td>åªèƒ½å­¦ä¹ ä¸€ç§æ¨¡å¼</td>
                        <td>åŒæ—¶å­¦ä¹ 8ç§ä¸åŒæ¨¡å¼</td>
                    </tr>
                    <tr>
                        <td><strong>å…³æ³¨ç»´åº¦</strong></td>
                        <td>å•ä¸€è§†è§’</td>
                        <td>å¤šä¸ªå­ç©ºé—´ï¼Œå¤šè§’åº¦è§‚å¯Ÿ</td>
                    </tr>
                    <tr>
                        <td><strong>é²æ£’æ€§</strong></td>
                        <td>è¾ƒå¼±</td>
                        <td>æ›´å¼ºï¼Œå¤šä¸ªå¤´äº’è¡¥</td>
                    </tr>
                    <tr>
                        <td><strong>è®¡ç®—æ•ˆç‡</strong></td>
                        <td>512Ã—512çŸ©é˜µä¹˜æ³•</td>
                        <td>8ä¸ª64Ã—64å¹¶è¡Œï¼Œæ›´é«˜æ•ˆ</td>
                    </tr>
                    <tr>
                        <td><strong>å‚æ•°é‡</strong></td>
                        <td>çº¦80ä¸‡</td>
                        <td>çº¦105ä¸‡ï¼ˆå¢åŠ 25%ï¼‰</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 9. ä»£ç å®ç° -->
        <div class="section">
            <h2 class="section-title">ä¹ã€PyTorchä»£ç å®ç°</h2>
            
            <div class="code-block">
<span style="color: #82b1ff;">import</span> torch
<span style="color: #82b1ff;">import</span> torch.nn <span style="color: #82b1ff;">as</span> nn
<span style="color: #82b1ff;">import</span> math

<span style="color: #82b1ff;">class</span> <span style="color: #ffb74d;">MultiHeadAttention</span>(nn.Module):
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">__init__</span>(self, d_model=512, num_heads=8):
        super().__init__()
        <span style="color: #82b1ff;">assert</span> d_model % num_heads == 0
        
        self.d_model = d_model
        self.num_heads = num_heads
        self.d_k = d_model // num_heads  <span style="color: #90a4ae;"># 64</span>
        
        <span style="color: #90a4ae;"># Qã€Kã€VæŠ•å½±çŸ©é˜µ</span>
        self.W_Q = nn.Linear(d_model, d_model)
        self.W_K = nn.Linear(d_model, d_model)
        self.W_V = nn.Linear(d_model, d_model)
        
        <span style="color: #90a4ae;"># è¾“å‡ºæŠ•å½±çŸ©é˜µ</span>
        self.W_O = nn.Linear(d_model, d_model)
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">split_heads</span>(self, x):
        <span style="color: #90a4ae;">"""åˆ†å‰²ä¸ºå¤šä¸ªå¤´"""</span>
        batch_size, seq_len, d_model = x.size()
        <span style="color: #90a4ae;"># (batch, seq_len, d_model) -> (batch, seq_len, num_heads, d_k)</span>
        x = x.view(batch_size, seq_len, self.num_heads, self.d_k)
        <span style="color: #90a4ae;"># (batch, seq_len, num_heads, d_k) -> (batch, num_heads, seq_len, d_k)</span>
        <span style="color: #82b1ff;">return</span> x.transpose(1, 2)
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">combine_heads</span>(self, x):
        <span style="color: #90a4ae;">"""æ‹¼æ¥å¤šä¸ªå¤´"""</span>
        batch_size, num_heads, seq_len, d_k = x.size()
        <span style="color: #90a4ae;"># (batch, num_heads, seq_len, d_k) -> (batch, seq_len, num_heads, d_k)</span>
        x = x.transpose(1, 2)
        <span style="color: #90a4ae;"># (batch, seq_len, num_heads, d_k) -> (batch, seq_len, d_model)</span>
        <span style="color: #82b1ff;">return</span> x.contiguous().view(batch_size, seq_len, self.d_model)
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">attention</span>(self, Q, K, V):
        <span style="color: #90a4ae;">"""è®¡ç®—å•å¤´æ³¨æ„åŠ›"""</span>
        d_k = Q.size(-1)
        scores = torch.matmul(Q, K.transpose(-2, -1)) / math.sqrt(d_k)
        attention_weights = torch.softmax(scores, dim=-1)
        output = torch.matmul(attention_weights, V)
        <span style="color: #82b1ff;">return</span> output
    
    <span style="color: #82b1ff;">def</span> <span style="color: #ffb74d;">forward</span>(self, Q, K, V):
        <span style="color: #90a4ae;"># 1. çº¿æ€§æŠ•å½±</span>
        Q = self.W_Q(Q)  <span style="color: #90a4ae;"># (batch, seq_len, d_model)</span>
        K = self.W_K(K)
        V = self.W_V(V)
        
        <span style="color: #90a4ae;"># 2. åˆ†å‰²ä¸ºå¤šä¸ªå¤´</span>
        Q = self.split_heads(Q)  <span style="color: #90a4ae;"># (batch, num_heads, seq_len, d_k)</span>
        K = self.split_heads(K)
        V = self.split_heads(V)
        
        <span style="color: #90a4ae;"># 3. è®¡ç®—æ³¨æ„åŠ›ï¼ˆ8ä¸ªå¤´å¹¶è¡Œï¼‰</span>
        attn_output = self.attention(Q, K, V)
        
        <span style="color: #90a4ae;"># 4. æ‹¼æ¥å¤´</span>
        output = self.combine_heads(attn_output)  <span style="color: #90a4ae;"># (batch, seq_len, d_model)</span>
        
        <span style="color: #90a4ae;"># 5. è¾“å‡ºæŠ•å½±</span>
        output = self.W_O(output)
        
        <span style="color: #82b1ff;">return</span> output

<span style="color: #90a4ae;"># ä½¿ç”¨ç¤ºä¾‹</span>
batch_size = 2
seq_len = 10
d_model = 512

mha = MultiHeadAttention(d_model=512, num_heads=8)
x = torch.randn(batch_size, seq_len, d_model)
output = mha(x, x, x)

<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"è¾“å…¥: {x.shape}"</span>)
<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"è¾“å‡º: {output.shape}"</span>)
<span style="color: #82b1ff;">print</span>(<span style="color: #aed581;">f"å‚æ•°é‡: {sum(p.numel() for p in mha.parameters()):,}"</span>)
            </div>
        </div>
        
        <!-- æ€»ç»“ -->
        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 30px; border-radius: 15px; margin-top: 40px;">
            <h3 style="color: #6a1b9a; text-align: center; margin-bottom: 20px; font-size: 1.5em;">
                âœ¨ æ ¸å¿ƒè¦ç‚¹æ€»ç»“
            </h3>
            <div style="color: #555; line-height: 2; font-size: 1.05em;">
                âœ“ å¤šå¤´æ³¨æ„åŠ›å°†512ç»´åˆ†å‰²ä¸º8ä¸ª64ç»´ï¼Œå¹¶è¡Œè®¡ç®—8æ¬¡æ³¨æ„åŠ›<br>
                âœ“ æ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„è¯­ä¹‰æ¨¡å¼ï¼Œæå‡æ¨¡å‹è¡¨è¾¾èƒ½åŠ›<br>
                âœ“ è®¡ç®—æµç¨‹ï¼šæŠ•å½±â†’åˆ†å‰²â†’å¹¶è¡Œæ³¨æ„åŠ›â†’æ‹¼æ¥â†’è¾“å‡ºæŠ•å½±<br>
                âœ“ ç›¸æ¯”å•å¤´ï¼Œå‚æ•°é‡ä»…å¢åŠ 25%ï¼Œä½†æ€§èƒ½å¤§å¹…æå‡<br>
                âœ“ è¿™æ˜¯Transformerèƒ½å¤Ÿç†è§£å¤æ‚è¯­è¨€ç°è±¡çš„å…³é”®æœºåˆ¶
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; color: #999; font-size: 0.9em;">
            <p>Â© 2025 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£ - Transformerç³»åˆ—æ•™ç¨‹</p>
        </div>
    </div>
</body>
</html>