<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š å¤è¯—å‘é‡æ£€ç´¢ç³»ç»Ÿ - Poetry Vector Search</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        .pulse-animation { animation: pulse 2s infinite; }

        .vector-viz {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 4px;
        }

        .similarity-bar {
            transition: width 0.8s ease-out;
        }

        .node circle {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node:hover circle {
            r: 8;
            stroke-width: 3;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .embedding-process {
            position: relative;
            overflow: hidden;
        }

        .vector-flow {
            animation: flow 2s ease-in-out infinite;
        }

        @keyframes flow {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-4">
                ğŸ“š å¤è¯—å‘é‡æ£€ç´¢ç³»ç»Ÿ
            </h1>
            <p class="text-xl text-gray-700">Poetry Vector Search with Embedding & ReRank Models</p>
        </header>

        <!-- Model Selection -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”§ æ¨¡å‹é…ç½®</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Embedding æ¨¡å‹</label>
                    <select id="embedding-model" class="w-full px-4 py-2 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                        <option value="bert">BERT-base-chinese (768ç»´)</option>
                        <option value="sentence-bert">Sentence-BERT (384ç»´)</option>
                        <option value="text2vec">Text2Vec-base (768ç»´)</option>
                        <option value="bge">BGE-large-zh (1024ç»´)</option>
                    </select>
                    <div id="embedding-info" class="mt-2 p-3 bg-blue-50 rounded-lg text-sm"></div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ReRank æ¨¡å‹</label>
                    <select id="rerank-model" class="w-full px-4 py-2 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="bge-reranker">BGE-Reranker-base</option>
                        <option value="cross-encoder">Cross-Encoder</option>
                        <option value="cohere">Cohere Rerank</option>
                        <option value="none">ä¸ä½¿ç”¨ReRank</option>
                    </select>
                    <div id="rerank-info" class="mt-2 p-3 bg-purple-50 rounded-lg text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ” è¯­ä¹‰æ£€ç´¢</h2>
            <div class="mb-4">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="è¾“å…¥æè¿°ï¼Œä¾‹å¦‚ï¼šæè¿°å‹æƒ…çš„è¯—å¥ã€æ€å¿µå®¶ä¹¡ã€æ˜¥å¤©çš„æ™¯è‰²..."
                    class="w-full px-6 py-4 text-lg border-2 border-indigo-200 rounded-xl focus:border-indigo-500 focus:outline-none"
                />
            </div>
            <div class="flex gap-4">
                <button id="search-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold rounded-xl hover:from-indigo-600 hover:to-purple-600 transition">
                    å¼€å§‹æ£€ç´¢
                </button>
                <button id="example-btn" class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition">
                    ç¤ºä¾‹æŸ¥è¯¢
                </button>
            </div>
        </div>

        <!-- Embedding Visualization -->
        <div id="embedding-viz" class="bg-white rounded-2xl shadow-xl p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§  Embedding è¿‡ç¨‹å¯è§†åŒ–</h2>
            
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="text-center">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <div class="font-bold text-gray-700">è¾“å…¥æ–‡æœ¬</div>
                    <div id="input-text" class="mt-2 p-3 bg-gray-50 rounded-lg text-sm"></div>
                </div>
                <div class="text-center">
                    <div class="text-4xl mb-2">âš™ï¸</div>
                    <div class="font-bold text-gray-700">æ¨¡å‹å¤„ç†</div>
                    <div id="model-process" class="mt-2 p-3 bg-indigo-50 rounded-lg text-sm"></div>
                </div>
                <div class="text-center">
                    <div class="text-4xl mb-2">ğŸ”¢</div>
                    <div class="font-bold text-gray-700">å‘é‡è¾“å‡º</div>
                    <div id="vector-output" class="mt-2 p-3 bg-purple-50 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
                <h3 class="font-bold text-gray-800 mb-3">ç”Ÿæˆçš„å‘é‡è¡¨ç¤º (å‰32ç»´å±•ç¤º)</h3>
                <div id="vector-display" class="grid grid-cols-8 gap-2"></div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="bg-white rounded-2xl shadow-xl p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š æ£€ç´¢ç»“æœ</h2>
            
            <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                <div class="flex items-center gap-2 mb-2">
                    <span class="font-bold">æ£€ç´¢ç»Ÿè®¡ï¼š</span>
                    <span id="search-stats"></span>
                </div>
                <div class="text-sm text-gray-600" id="rerank-status"></div>
            </div>

            <div id="results-container"></div>
        </div>

        <!-- Vector Space Visualization -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸŒŒ å‘é‡ç©ºé—´å¯è§†åŒ– (50é¦–å¤è¯—)</h2>
            <div class="mb-4 flex gap-4">
                <button id="show-all-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
                    æ˜¾ç¤ºå…¨éƒ¨
                </button>
                <button id="show-similar-btn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                    æ˜¾ç¤ºç›¸ä¼¼ç»„
                </button>
                <select id="theme-select" class="px-4 py-2 border-2 border-gray-200 rounded-lg">
                    <option value="all">æ‰€æœ‰ä¸»é¢˜</option>
                    <option value="friendship">å‹æƒ…</option>
                    <option value="nature">è‡ªç„¶</option>
                    <option value="homesick">æ€ä¹¡</option>
                    <option value="love">çˆ±æƒ…</option>
                </select>
            </div>
            <div id="vector-space" class="border-2 border-gray-200 rounded-xl bg-gray-50"></div>
            <div class="mt-4 grid md:grid-cols-2 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="font-bold text-gray-700 mb-2">ğŸ“ é€‰ä¸­çš„è¯—å¥</div>
                    <div id="selected-poetry" class="text-sm text-gray-600">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="font-bold text-gray-700 mb-2">ğŸ”¢ å‘é‡ä¿¡æ¯</div>
                    <div id="selected-vector" class="text-sm text-gray-600 font-mono">-</div>
                </div>
            </div>
        </div>

        <!-- Poetry Database -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“– å¤è¯—æ•°æ®åº“ (50é¦–)</h2>
            <div class="mb-4">
                <input 
                    type="text" 
                    id="filter-input" 
                    placeholder="è¿‡æ»¤è¯—å¥..."
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none"
                />
            </div>
            <div id="poetry-list" class="grid md:grid-cols-2 gap-4 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Poetry Database with 50 Chinese poems
        const poetryDatabase = [
            // å‹æƒ…ä¸»é¢˜
            { id: 1, text: "æµ·å†…å­˜çŸ¥å·±ï¼Œå¤©æ¶¯è‹¥æ¯”é‚»", author: "ç‹å‹ƒ", theme: "friendship", vector: null },
            { id: 2, text: "æ¡ƒèŠ±æ½­æ°´æ·±åƒå°ºï¼Œä¸åŠæ±ªä¼¦é€æˆ‘æƒ…", author: "æç™½", theme: "friendship", vector: null },
            { id: 3, text: "åŠå›æ›´å°½ä¸€æ¯é…’ï¼Œè¥¿å‡ºé˜³å…³æ— æ•…äºº", author: "ç‹ç»´", theme: "friendship", vector: null },
            { id: 4, text: "è«æ„å‰è·¯æ— çŸ¥å·±ï¼Œå¤©ä¸‹è°äººä¸è¯†å›", author: "é«˜é€‚", theme: "friendship", vector: null },
            { id: 5, text: "æ•…äººè¥¿è¾é»„é¹¤æ¥¼ï¼ŒçƒŸèŠ±ä¸‰æœˆä¸‹æ‰¬å·", author: "æç™½", theme: "friendship", vector: null },
            
            // è‡ªç„¶æ™¯è‰²
            { id: 6, text: "æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿ", author: "å­Ÿæµ©ç„¶", theme: "nature", vector: null },
            { id: 7, text: "æ—¥å‡ºæ±ŸèŠ±çº¢èƒœç«ï¼Œæ˜¥æ¥æ±Ÿæ°´ç»¿å¦‚è“", author: "ç™½å±…æ˜“", theme: "nature", vector: null },
            { id: 8, text: "æ¥å¤©è²å¶æ— ç©·ç¢§ï¼Œæ˜ æ—¥è·èŠ±åˆ«æ ·çº¢", author: "æ¨ä¸‡é‡Œ", theme: "nature", vector: null },
            { id: 9, text: "åƒé‡Œèºå•¼ç»¿æ˜ çº¢ï¼Œæ°´æ‘å±±éƒ­é…’æ——é£", author: "æœç‰§", theme: "nature", vector: null },
            { id: 10, text: "ç«¹å¤–æ¡ƒèŠ±ä¸‰ä¸¤æï¼Œæ˜¥æ±Ÿæ°´æš–é¸­å…ˆçŸ¥", author: "è‹è½¼", theme: "nature", vector: null },
            
            // æ€ä¹¡ä¸»é¢˜
            { id: 11, text: "ç‹¬åœ¨å¼‚ä¹¡ä¸ºå¼‚å®¢ï¼Œæ¯é€¢ä½³èŠ‚å€æ€äº²", author: "ç‹ç»´", theme: "homesick", vector: null },
            { id: 12, text: "ä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡", author: "æç™½", theme: "homesick", vector: null },
            { id: 13, text: "éœ²ä»ä»Šå¤œç™½ï¼Œæœˆæ˜¯æ•…ä¹¡æ˜", author: "æœç”«", theme: "homesick", vector: null },
            { id: 14, text: "æ—¥æš®ä¹¡å…³ä½•å¤„æ˜¯ï¼ŒçƒŸæ³¢æ±Ÿä¸Šä½¿äººæ„", author: "å´”é¢¢", theme: "homesick", vector: null },
            { id: 15, text: "æ´›é˜³äº²å‹å¦‚ç›¸é—®ï¼Œä¸€ç‰‡å†°å¿ƒåœ¨ç‰å£¶", author: "ç‹æ˜Œé¾„", theme: "homesick", vector: null },
            
            // çˆ±æƒ…ä¸»é¢˜
            { id: 16, text: "æ„¿å¾—ä¸€å¿ƒäººï¼Œç™½å¤´ä¸ç›¸ç¦»", author: "å“æ–‡å›", theme: "love", vector: null },
            { id: 17, text: "æ›¾ç»æ²§æµ·éš¾ä¸ºæ°´ï¼Œé™¤å´å·«å±±ä¸æ˜¯äº‘", author: "å…ƒç¨¹", theme: "love", vector: null },
            { id: 18, text: "èº«æ— å½©å‡¤åŒé£ç¿¼ï¼Œå¿ƒæœ‰çµçŠ€ä¸€ç‚¹é€š", author: "æå•†éš", theme: "love", vector: null },
            { id: 19, text: "è¡£å¸¦æ¸å®½ç»ˆä¸æ‚”ï¼Œä¸ºä¼Šæ¶ˆå¾—äººæ†”æ‚´", author: "æŸ³æ°¸", theme: "love", vector: null },
            { id: 20, text: "ä¸¤æƒ…è‹¥æ˜¯ä¹…é•¿æ—¶ï¼Œåˆå²‚åœ¨æœæœæš®æš®", author: "ç§¦è§‚", theme: "love", vector: null },
            
            // å±±æ°´ç”°å›­
            { id: 21, text: "ç©ºå±±æ–°é›¨åï¼Œå¤©æ°”æ™šæ¥ç§‹", author: "ç‹ç»´", theme: "nature", vector: null },
            { id: 22, text: "æ˜æœˆæ¾é—´ç…§ï¼Œæ¸…æ³‰çŸ³ä¸Šæµ", author: "ç‹ç»´", theme: "nature", vector: null },
            { id: 23, text: "é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±", author: "é™¶æ¸Šæ˜", theme: "nature", vector: null },
            { id: 24, text: "å±±é‡æ°´å¤ç–‘æ— è·¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘", author: "é™†æ¸¸", theme: "nature", vector: null },
            { id: 25, text: "ç»¿æ ‘æ‘è¾¹åˆï¼Œé’å±±éƒ­å¤–æ–œ", author: "å­Ÿæµ©ç„¶", theme: "nature", vector: null },
            
            // äººç”Ÿæ„Ÿæ‚Ÿ
            { id: 26, text: "äººç”Ÿå¾—æ„é¡»å°½æ¬¢ï¼Œè«ä½¿é‡‘æ¨½ç©ºå¯¹æœˆ", author: "æç™½", theme: "life", vector: null },
            { id: 27, text: "äººç”Ÿè‡ªå¤è°æ— æ­»ï¼Œç•™å–ä¸¹å¿ƒç…§æ±—é’", author: "æ–‡å¤©ç¥¥", theme: "life", vector: null },
            { id: 28, text: "é•¿é£ç ´æµªä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†æµæ²§æµ·", author: "æç™½", theme: "life", vector: null },
            { id: 29, text: "ä¼šå½“å‡Œç»é¡¶ï¼Œä¸€è§ˆä¼—å±±å°", author: "æœç”«", theme: "life", vector: null },
            { id: 30, text: "ä¸ç•æµ®äº‘é®æœ›çœ¼ï¼Œåªç¼˜èº«åœ¨æœ€é«˜å±‚", author: "ç‹å®‰çŸ³", theme: "life", vector: null },
            
            // è¾¹å¡å†›æ—…
            { id: 31, text: "é»„æ²™ç™¾æˆ˜ç©¿é‡‘ç”²ï¼Œä¸ç ´æ¥¼å…°ç»ˆä¸è¿˜", author: "ç‹æ˜Œé¾„", theme: "military", vector: null },
            { id: 32, text: "ä½†ä½¿é¾™åŸé£å°†åœ¨ï¼Œä¸æ•™èƒ¡é©¬åº¦é˜´å±±", author: "ç‹æ˜Œé¾„", theme: "military", vector: null },
            { id: 33, text: "ç¾Œç¬›ä½•é¡»æ€¨æ¨æŸ³ï¼Œæ˜¥é£ä¸åº¦ç‰é—¨å…³", author: "ç‹ä¹‹æ¶£", theme: "military", vector: null },
            { id: 34, text: "é†‰å§æ²™åœºå›è«ç¬‘ï¼Œå¤æ¥å¾æˆ˜å‡ äººå›", author: "ç‹ç¿°", theme: "military", vector: null },
            { id: 35, text: "è‘¡è„ç¾é…’å¤œå…‰æ¯ï¼Œæ¬²é¥®çµç¶é©¬ä¸Šå‚¬", author: "ç‹ç¿°", theme: "military", vector: null },
            
            // ç§‹å†¬æ™¯è‰²
            { id: 36, text: "åœè½¦åçˆ±æ«æ—æ™šï¼Œéœœå¶çº¢äºäºŒæœˆèŠ±", author: "æœç‰§", theme: "nature", vector: null },
            { id: 37, text: "å¿½å¦‚ä¸€å¤œæ˜¥é£æ¥ï¼Œåƒæ ‘ä¸‡æ ‘æ¢¨èŠ±å¼€", author: "å²‘å‚", theme: "nature", vector: null },
            { id: 38, text: "å­¤èˆŸè“‘ç¬ ç¿ï¼Œç‹¬é’“å¯’æ±Ÿé›ª", author: "æŸ³å®—å…ƒ", theme: "nature", vector: null },
            { id: 39, text: "æ™´ç©ºä¸€é¹¤æ’äº‘ä¸Šï¼Œä¾¿å¼•è¯—æƒ…åˆ°ç¢§éœ„", author: "åˆ˜ç¦¹é”¡", theme: "nature", vector: null },
            { id: 40, text: "é“¶çƒ›ç§‹å…‰å†·ç”»å±ï¼Œè½»ç½—å°æ‰‡æ‰‘æµè¤", author: "æœç‰§", theme: "nature", vector: null },
            
            // ç¦»åˆ«æƒ†æ€…
            { id: 41, text: "å¤šæƒ…è‡ªå¤ä¼¤ç¦»åˆ«ï¼Œæ›´é‚£å ªå†·è½æ¸…ç§‹èŠ‚", author: "æŸ³æ°¸", theme: "parting", vector: null },
            { id: 42, text: "ç›¸è§æ—¶éš¾åˆ«äº¦éš¾ï¼Œä¸œé£æ— åŠ›ç™¾èŠ±æ®‹", author: "æå•†éš", theme: "parting", vector: null },
            { id: 43, text: "æ­¤æƒ…å¯å¾…æˆè¿½å¿†ï¼Œåªæ˜¯å½“æ—¶å·²æƒ˜ç„¶", author: "æå•†éš", theme: "parting", vector: null },
            { id: 44, text: "å»å¹´ä»Šæ—¥æ­¤é—¨ä¸­ï¼Œäººé¢æ¡ƒèŠ±ç›¸æ˜ çº¢", author: "å´”æŠ¤", theme: "parting", vector: null },
            { id: 45, text: "äººç”Ÿè‹¥åªå¦‚åˆè§ï¼Œä½•äº‹ç§‹é£æ‚²ç”»æ‰‡", author: "çº³å…°æ€§å¾·", theme: "parting", vector: null },
            
            // å’ç‰©æŠ’æ€€
            { id: 46, text: "æ¢…é¡»é€Šé›ªä¸‰åˆ†ç™½ï¼Œé›ªå´è¾“æ¢…ä¸€æ®µé¦™", author: "å¢æ¢…å¡", theme: "nature", vector: null },
            { id: 47, text: "å¢™è§’æ•°ææ¢…ï¼Œå‡Œå¯’ç‹¬è‡ªå¼€", author: "ç‹å®‰çŸ³", theme: "nature", vector: null },
            { id: 48, text: "ä¸è¦äººå¤¸å¥½é¢œè‰²ï¼Œåªç•™æ¸…æ°”æ»¡ä¹¾å¤", author: "ç‹å†•", theme: "nature", vector: null },
            { id: 49, text: "é‡ç«çƒ§ä¸å°½ï¼Œæ˜¥é£å¹åˆç”Ÿ", author: "ç™½å±…æ˜“", theme: "nature", vector: null },
            { id: 50, text: "è½çº¢ä¸æ˜¯æ— æƒ…ç‰©ï¼ŒåŒ–ä½œæ˜¥æ³¥æ›´æŠ¤èŠ±", author: "é¾šè‡ªç", theme: "nature", vector: null }
        ];

        // Embedding model configurations
        const embeddingModels = {
            'bert': {
                name: 'BERT-base-chinese',
                dim: 768,
                description: 'ğŸ¯ ä½œç”¨ï¼šåŸºç¡€ä¸­æ–‡è¯­ä¹‰ç†è§£<br>ğŸ“Š ç»´åº¦ï¼š768ç»´<br>âš¡ ç‰¹ç‚¹ï¼šå¹³è¡¡æ€§èƒ½ä¸æ•ˆæœï¼Œé€‚åˆé€šç”¨åœºæ™¯<br>ğŸ”§ æ¶æ„ï¼šTransformerç¼–ç å™¨ï¼Œ12å±‚',
                speed: 'ä¸­ç­‰',
                accuracy: 'è‰¯å¥½'
            },
            'sentence-bert': {
                name: 'Sentence-BERT',
                dim: 384,
                description: 'ğŸ¯ ä½œç”¨ï¼šä¼˜åŒ–å¥å­çº§è¯­ä¹‰ç›¸ä¼¼åº¦<br>ğŸ“Š ç»´åº¦ï¼š384ç»´<br>âš¡ ç‰¹ç‚¹ï¼šä¸“é—¨ä¼˜åŒ–ç›¸ä¼¼åº¦è®¡ç®—ï¼Œé€Ÿåº¦å¿«<br>ğŸ”§ æ¶æ„ï¼šBERT + Siameseç½‘ç»œç»“æ„',
                speed: 'å¿«é€Ÿ',
                accuracy: 'ä¼˜ç§€'
            },
            'text2vec': {
                name: 'Text2Vec-base',
                dim: 768,
                description: 'ğŸ¯ ä½œç”¨ï¼šä¸­æ–‡æ–‡æœ¬å‘é‡åŒ–<br>ğŸ“Š ç»´åº¦ï¼š768ç»´<br>âš¡ ç‰¹ç‚¹ï¼šé’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–ï¼Œæ•ˆæœå¥½<br>ğŸ”§ æ¶æ„ï¼šåŸºäºBERTæ”¹è¿›ï¼Œä¸­æ–‡è¯­æ–™å¾®è°ƒ',
                speed: 'ä¸­ç­‰',
                accuracy: 'ä¼˜ç§€'
            },
            'bge': {
                name: 'BGE-large-zh',
                dim: 1024,
                description: 'ğŸ¯ ä½œç”¨ï¼šå¤§è§„æ¨¡è¯­ä¹‰æ£€ç´¢<br>ğŸ“Š ç»´åº¦ï¼š1024ç»´<br>âš¡ ç‰¹ç‚¹ï¼šæ£€ç´¢æ•ˆæœæœ€ä½³ï¼Œä¿¡æ¯é‡å¤§<br>ğŸ”§ æ¶æ„ï¼š24å±‚Transformerï¼Œå¤§è§„æ¨¡é¢„è®­ç»ƒ',
                speed: 'è¾ƒæ…¢',
                accuracy: 'æä½³'
            }
        };

        // ReRank model configurations
        const rerankModels = {
            'bge-reranker': {
                name: 'BGE-Reranker-base',
                description: 'ğŸ¯ ä½œç”¨ï¼šç²¾æ’åºä¼˜åŒ–<br>âš¡ åŸç†ï¼šå¯¹å¬å›ç»“æœè¿›è¡Œç²¾ç¡®æ‰“åˆ†é‡æ’<br>ğŸ“ˆ æå‡ï¼šå‡†ç¡®ç‡æå‡15-20%<br>ğŸ”§ æ–¹æ³•ï¼šCross-Attentionè®¡ç®—query-docç›¸å…³æ€§',
                method: 'Cross-Attention'
            },
            'cross-encoder': {
                name: 'Cross-Encoder',
                description: 'ğŸ¯ ä½œç”¨ï¼šæ·±åº¦è¯­ä¹‰åŒ¹é…<br>âš¡ åŸç†ï¼šåŒæ—¶ç¼–ç queryå’Œdocè®¡ç®—ç›¸å…³æ€§<br>ğŸ“ˆ æå‡ï¼šå‡†ç¡®ç‡æå‡20-30%<br>ğŸ”§ æ–¹æ³•ï¼šè”åˆç¼–ç  + äºŒåˆ†ç±»',
                method: 'Joint Encoding'
            },
            'cohere': {
                name: 'Cohere Rerank',
                description: 'ğŸ¯ ä½œç”¨ï¼šå•†ä¸šçº§ç²¾æ’<br>âš¡ åŸç†ï¼šå¤šè¯­è¨€æ·±åº¦å­¦ä¹ æ¨¡å‹<br>ğŸ“ˆ æå‡ï¼šå‡†ç¡®ç‡æå‡25-35%<br>ğŸ”§ æ–¹æ³•ï¼šå¤§è§„æ¨¡Transformer + æ’åºå­¦ä¹ ',
                method: 'Learning to Rank'
            },
            'none': {
                name: 'ä¸ä½¿ç”¨ReRank',
                description: 'âš ï¸ ä»…ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æ’åº<br>ğŸ“Š å¯èƒ½å­˜åœ¨è¯­ä¹‰åå·®<br>ğŸ” é€‚åˆï¼šå¿«é€Ÿæ£€ç´¢åœºæ™¯',
                method: 'Cosine Similarity Only'
            }
        };

        // Generate vectors for each poetry (simulated)
        function generateVector(text, dim) {
            // Simple hash-based vector generation (for demo purposes)
            const vector = [];
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = ((hash << 5) - hash) + text.charCodeAt(i);
                hash = hash & hash;
            }
            
            const random = new Math.seedrandom(hash);
            for (let i = 0; i < dim; i++) {
                vector.push((random() * 2 - 1).toFixed(4));
            }
            return vector;
        }

        // Math.seedrandom implementation
        Math.seedrandom = function(seed) {
            const m = 0x80000000;
            const a = 1103515245;
            const c = 12345;
            let state = seed ? seed : Math.floor(Math.random() * (m - 1));
            return function() {
                state = (a * state + c) % m;
                return state / (m - 1);
            };
        };

        // Calculate cosine similarity
        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += parseFloat(vecA[i]) * parseFloat(vecB[i]);
                normA += parseFloat(vecA[i]) ** 2;
                normB += parseFloat(vecB[i]) ** 2;
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        // Initialize vectors for all poetry
        function initializeVectors() {
            const model = $('#embedding-model').val();
            const dim = embeddingModels[model].dim;
            
            poetryDatabase.forEach(poetry => {
                poetry.vector = generateVector(poetry.text, dim);
            });
        }

        // Update model info
        function updateModelInfo() {
            const embeddingModel = $('#embedding-model').val();
            const rerankModel = $('#rerank-model').val();
            
            $('#embedding-info').html(embeddingModels[embeddingModel].description);
            $('#rerank-info').html(rerankModels[rerankModel].description);
        }

        // Render poetry list
        function renderPoetryList(filter = '') {
            const container = $('#poetry-list');
            container.empty();
            
            const filtered = poetryDatabase.filter(p => 
                p.text.includes(filter) || p.author.includes(filter)
            );
            
            filtered.forEach(poetry => {
                const card = $(`
                    <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-indigo-100 hover:border-indigo-300 transition cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs px-2 py-1 bg-indigo-500 text-white rounded">${poetry.theme}</span>
                            <span class="text-xs text-gray-500">#${poetry.id}</span>
                        </div>
                        <div class="text-lg font-bold text-gray-800 mb-1">${poetry.text}</div>
                        <div class="text-sm text-gray-600">â€”â€” ${poetry.author}</div>
                        <div class="mt-2 text-xs text-gray-500 font-mono">
                            Vector dim: ${poetry.vector ? poetry.vector.length : 0}
                        </div>
                    </div>
                `);
                
                card.click(() => {
                    highlightNode(poetry.id);
                    showPoetryDetail(poetry);
                });
                
                container.append(card);
            });
        }

        // Show poetry detail
        function showPoetryDetail(poetry) {
            $('#selected-poetry').html(`
                <div class="font-bold">${poetry.text}</div>
                <div class="text-xs mt-1">ä½œè€…ï¼š${poetry.author} | ä¸»é¢˜ï¼š${poetry.theme}</div>
            `);
            
            if (poetry.vector) {
                const vectorPreview = poetry.vector.slice(0, 8).join(', ') + '...';
                $('#selected-vector').html(`
                    [${vectorPreview}]<br>
                    <span class="text-xs text-gray-500">ç»´åº¦: ${poetry.vector.length}</span>
                `);
            }
        }

        // Render vector space visualization
        function renderVectorSpace() {
            const width = $('#vector-space').width();
            const height = 600;
            
            $('#vector-space').empty();
            
            const svg = d3.select('#vector-space')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Use t-SNE-like projection (simplified 2D projection)
            const nodes = poetryDatabase.map((poetry, i) => {
                const angle = (i / poetryDatabase.length) * 2 * Math.PI;
                const radius = 200 + Math.random() * 100;
                return {
                    id: poetry.id,
                    x: width / 2 + Math.cos(angle) * radius,
                    y: height / 2 + Math.sin(angle) * radius,
                    text: poetry.text,
                    theme: poetry.theme,
                    author: poetry.author
                };
            });

            // Create links between similar poems
            const links = [];
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    if (poetryDatabase[i].theme === poetryDatabase[j].theme) {
                        const similarity = cosineSimilarity(
                            poetryDatabase[i].vector,
                            poetryDatabase[j].vector
                        );
                        if (similarity > 0.7) {
                            links.push({
                                source: nodes[i],
                                target: nodes[j],
                                similarity: similarity
                            });
                        }
                    }
                }
            }

            // Draw links
            svg.selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y)
                .attr('stroke-width', d => d.similarity * 2);

            // Theme colors
            const themeColors = {
                friendship: '#3b82f6',
                nature: '#10b981',
                homesick: '#f59e0b',
                love: '#ec4899',
                life: '#8b5cf6',
                military: '#ef4444',
                parting: '#6366f1'
            };

            // Draw nodes
            const node = svg.selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            node.append('circle')
                .attr('r', 5)
                .attr('fill', d => themeColors[d.theme] || '#6b7280')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            node.on('mouseover', function(event, d) {
                d3.select('#tooltip')
                    .style('opacity', 1)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px')
                    .html(`<strong>${d.text}</strong><br>${d.author}<br>ä¸»é¢˜: ${d.theme}`);
            })
            .on('mouseout', function() {
                d3.select('#tooltip').style('opacity', 0);
            })
            .on('click', function(event, d) {
                const poetry = poetryDatabase.find(p => p.id === d.id);
                showPoetryDetail(poetry);
            });
        }

        // Highlight node in visualization
        function highlightNode(id) {
            d3.selectAll('.node circle')
                .attr('r', 5)
                .attr('stroke-width', 2);
            
            d3.selectAll('.node')
                .filter(d => d.id === id)
                .select('circle')
                .attr('r', 8)
                .attr('stroke-width', 3)
                .attr('stroke', '#fbbf24');
        }

        // Show embedding visualization
        function showEmbeddingViz(text) {
            $('#embedding-viz').removeClass('hidden').addClass('fade-in');
            
            const model = $('#embedding-model').val();
            const modelInfo = embeddingModels[model];
            
            $('#input-text').text(text);
            $('#model-process').html(`
                <div class="font-bold">${modelInfo.name}</div>
                <div class="text-xs mt-1">å¤„ç†ä¸­...</div>
            `);
            
            setTimeout(() => {
                const vector = generateVector(text, modelInfo.dim);
                
                $('#model-process').html(`
                    <div class="font-bold">${modelInfo.name}</div>
                    <div class="text-xs mt-1 text-green-600">âœ“ å®Œæˆ</div>
                `);
                
                $('#vector-output').html(`
                    <div class="font-bold">${modelInfo.dim}ç»´å‘é‡</div>
                    <div class="text-xs mt-1">é•¿åº¦: ${vector.length}</div>
                `);
                
                // Display first 32 dimensions
                const display = $('#vector-display');
                display.empty();
                
                vector.slice(0, 32).forEach((val, idx) => {
                    const value = parseFloat(val);
                    const color = value > 0 ? 'from-green-400 to-green-600' : 'from-red-400 to-red-600';
                    const height = Math.abs(value) * 50 + 20;
                    
                    display.append(`
                        <div class="text-center">
                            <div class="h-16 flex items-end justify-center mb-1">
                                <div class="w-full bg-gradient-to-t ${color} rounded-t" style="height: ${height}px"></div>
                            </div>
                            <div class="text-xs font-mono">${val}</div>
                            <div class="text-xs text-gray-400">D${idx + 1}</div>
                        </div>
                    `);
                });
            }, 800);
        }

        // Search function
        function performSearch(query) {
            showEmbeddingViz(query);
            
            const model = $('#embedding-model').val();
            const dim = embeddingModels[model].dim;
            const queryVector = generateVector(query, dim);
            
            // Calculate similarities
            const results = poetryDatabase.map(poetry => ({
                ...poetry,
                similarity: cosineSimilarity(queryVector, poetry.vector)
            })).sort((a, b) => b.similarity - a.similarity);
            
            // Apply ReRank if enabled
            const rerankModel = $('#rerank-model').val();
            let finalResults = results;
            
            if (rerankModel !== 'none') {
                // Simulate reranking (boost semantic matches)
                finalResults = results.map(r => ({
                    ...r,
                    rerankScore: r.similarity * (1 + Math.random() * 0.2)
                })).sort((a, b) => b.rerankScore - a.rerankScore);
            }
            
            displayResults(query, finalResults.slice(0, 10), rerankModel);
        }

        // Display search results
        function displayResults(query, results, rerankModel) {
            $('#search-results').removeClass('hidden').addClass('fade-in');
            
            $('#search-stats').html(`
                æŸ¥è¯¢: <span class="text-indigo-600">"${query}"</span> | 
                æ‰¾åˆ° <span class="font-bold text-green-600">${results.length}</span> æ¡ç»“æœ
            `);
            
            const rerankStatus = rerankModel !== 'none' 
                ? `âœ… å·²ä½¿ç”¨ ${rerankModels[rerankModel].name} é‡æ’åº` 
                : 'âš ï¸ æœªä½¿ç”¨ReRankï¼Œä»…æŒ‰å‘é‡ç›¸ä¼¼åº¦æ’åº';
            $('#rerank-status').text(rerankStatus);
            
            const container = $('#results-container');
            container.empty();
            
            results.forEach((result, index) => {
                const similarity = (result.similarity * 100).toFixed(2);
                const rerankScore = result.rerankScore ? (result.rerankScore * 100).toFixed(2) : null;
                
                const card = $(`
                    <div class="mb-4 p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200 hover:border-indigo-400 transition">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl font-bold text-indigo-600">#${index + 1}</div>
                                <div>
                                    <div class="text-xl font-bold text-gray-800">${result.text}</div>
                                    <div class="text-sm text-gray-600">â€”â€” ${result.author}</div>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-${index < 3 ? 'green' : 'blue'}-500 text-white rounded-full text-sm">
                                ${result.theme}
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">å‘é‡ç›¸ä¼¼åº¦</span>
                                    <span class="font-bold text-indigo-600">${similarity}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="similarity-bar bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full" style="width: ${similarity}%"></div>
                                </div>
                            </div>
                            
                            ${rerankScore ? `
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">ReRankå¾—åˆ†</span>
                                    <span class="font-bold text-purple-600">${rerankScore}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="similarity-bar bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: ${rerankScore}%"></div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-3 p-2 bg-gray-100 rounded text-xs font-mono text-gray-600">
                            <div class="font-bold mb-1">å‘é‡è¡¨ç¤º (å‰8ç»´):</div>
                            [${result.vector.slice(0, 8).join(', ')}...]
                        </div>
                    </div>
                `);
                
                container.append(card);
            });
        }

        // Initialize
        $(document).ready(function() {
            initializeVectors();
            updateModelInfo();
            renderPoetryList();
            renderVectorSpace();

            // Event listeners
            $('#embedding-model').change(function() {
                initializeVectors();
                updateModelInfo();
                renderVectorSpace();
            });

            $('#rerank-model').change(updateModelInfo);

            $('#search-btn').click(function() {
                const query = $('#search-input').val().trim();
                if (query) {
                    performSearch(query);
                }
            });

            $('#example-btn').click(function() {
                const examples = [
                    'æå†™å‹æƒ…çš„è¯—å¥',
                    'æ€å¿µå®¶ä¹¡çš„æ„Ÿå—',
                    'æ˜¥å¤©çš„ç¾ä¸½æ™¯è‰²',
                    'è¡¨è¾¾çˆ±æ„çš„è¯—',
                    'ç¦»åˆ«çš„æƒ†æ€…'
                ];
                const random = examples[Math.floor(Math.random() * examples.length)];
                $('#search-input').val(random);
                performSearch(random);
            });

            $('#search-input').keypress(function(e) {
                if (e.which === 13) {
                    $('#search-btn').click();
                }
            });

            $('#filter-input').on('input', function() {
                renderPoetryList($(this).val());
            });

            $('#show-all-btn').click(renderVectorSpace);

            $('#theme-select').change(function() {
                const theme = $(this).val();
                if (theme === 'all') {
                    renderPoetryList();
                } else {
                    const filtered = poetryDatabase.filter(p => p.theme === theme);
                    $('#poetry-list').empty();
                    filtered.forEach(poetry => {
                        const card = $(`
                            <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-indigo-100">
                                <div class="text-lg font-bold text-gray-800 mb-1">${poetry.text}</div>
                                <div class="text-sm text-gray-600">â€”â€” ${poetry.author}</div>
                            </div>
                        `);
                        $('#poetry-list').append(card);
                    });
                }
            });
        });
    </script>
</body>
</html>
